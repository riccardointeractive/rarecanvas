# Lessons Learned - January 8, 2025

## Session Focus
Transaction history improvements, fee modal fixes, KONG token support, and AMM behavior investigation.

---

## Key Discoveries

### 1. Token Decimals in API Routes
**Problem:** Swap history API had hardcoded decimals, causing KONG (3 decimals) to display incorrectly.
**Solution:** Import and use `getTokenDecimals()` from centralized `@/config/tokens.ts` instead of hardcoded values.
**Pattern:** Always use centralized token config for decimal handling - never hardcode.

```typescript
// Before (bad)
const getDecimals = (assetId: string): number => {
  if (assetId === 'KLV') return 6;
  if (assetId.startsWith('DGKO')) return 4;
  return 6; // Wrong for KONG (3 decimals)
};

// After (good)
import { getTokenDecimals } from '@/config/tokens';
const decimals = getTokenDecimals(assetId) || getTokenDecimals(symbol);
```

### 2. AMM Behavior Analysis
**Scenario:** User swapped 35.7M KONG and got 97.5K KLV. Initially looked like exploit.
**Reality:** AMM constant product formula working correctly - massive slippage due to swap size (31% of pool).
**Lesson:** Large swaps relative to pool size always incur heavy slippage. This is expected AMM behavior, not a bug.

### 3. Mobile Filter Pills UX
**Problem:** Horizontal scrolling pills on mobile were cut off with no scroll indication.
**Solution:** 
- Add fade gradient on right edge (`from-[#0a0a0b]`)
- Add extra padding (`pr-8`) so last pill isn't cut off
- Only show gradient on mobile (`md:hidden`)

### 4. Token Logo Transparency Issue
**Problem:** KONG logo with transparent/black background disappears on dark site background.
**Solution:** Add solid dark background (#0a0a0b) using PIL before saving:
```python
background = Image.new('RGBA', img.size, (10, 10, 11, 255))
background.paste(img, (0, 0), img)
background.save('kong.png')
```

### 5. Dynamic Fee Display
**Problem:** Fee modal hardcoded "1%" when fees vary per trading pair.
**Solution:** Pass `platformFeePercent` from pair config to `FeeDetailsModal` component.

---

## Files Modified

### Core Changes
- `src/app/api/swap-history/route.ts` - Use centralized token decimals
- `src/app/swap/components/FeeDetailsModal.tsx` - Dynamic fee percentage
- `src/app/swap/components/BlockchainTransactionHistory.tsx` - Filter pills, mobile UX
- `src/app/swap/page.tsx` - Pass fee percent to modal, consistent padding
- `src/app/pool/page.tsx` - Sort pairs by liquidity, consistent padding
- `src/app/history/page.tsx` - Consistent padding
- `src/config/tokens.ts` - Add KONG logo path

### Assets
- `public/tokens/kong.png` - New token logo

### Documentation
- `src/app/documentation/config/sections/04-swap.tsx` - Update fees info, add KONG pair
- `content/updates/v1-22-0.md` - Public release notes

---

## Architecture Decisions

### Filter Implementation
Chose single-token filter (show all swaps involving token X) over pair filter (DGKO/KLV) because:
1. Simpler UX - fewer options to manage
2. More useful - users typically care about "all my DGKO activity"
3. Better for mobile - less horizontal scrolling needed

### Page Padding Standardization
Unified all DEX pages to `py-4 md:py-8 lg:py-8`:
- Reduces visual jumping between pages
- Less aggressive desktop padding (was py-12/py-16)
- Consistent user experience

---

## Known Issues (Deferred)

1. **TypeScript validation errors** - Pre-existing @types/node issues in redis.ts, tokenPrices.ts. Build succeeds despite these.

---

**Session Duration:** ~3 hours
**Build Status:** âœ… Passing (Vercel)
