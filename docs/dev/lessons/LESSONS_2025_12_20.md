# Lessons Learned: Price Chart Pair Filtering & Redis Caching
## December 20, 2025

### Session Summary
Fixed critical bug where price charts displayed incorrect prices (4000 KLV for DGKO) due to including swaps from all pairs instead of the selected pair. Also optimized Redis cache sync interval for faster transaction updates.

---

## ðŸ› Bug #1: Price Chart Showing Wrong Prices

**Symptom:** DGKO price chart showed values like "4000 KLV" when actual price is ~0.02 KLV

**Root Cause:** `usePriceData.ts` filtered transactions by token only, not by trading pair:

```typescript
// âŒ OLD (BUGGY) - Includes ALL swaps involving the token
const tokenTxs = transactions.filter(tx => 
  tx.inputToken === displayToken || tx.outputToken === displayToken
);
```

This included:
- âœ… DGKO â†’ KLV swaps (correct)
- âœ… KLV â†’ DGKO swaps (correct)
- âŒ DGKO â†’ BABYDGKO swaps (WRONG!)
- âŒ BABYDGKO â†’ DGKO swaps (WRONG!)

**The Math Problem:**
For a DGKO â†’ BABYDGKO swap (1000 DGKO â†’ 4,000,000 BABYDGKO):
```
price = outputAmount / inputAmount
price = 4,000,000 / 1,000 = 4000
```
This 4000 was displayed as "4000 KLV" but it's actually BABYDGKO!

---

## âœ… Fix #1: Pair-Aware Filtering

### Files Modified:

**`src/app/swap/hooks/usePriceData.ts`**
- Added `quoteToken` parameter to filter by trading pair
- Changed filter to require BOTH tokens match the pair:

```typescript
// âœ… NEW - Filters by PAIR (both tokens must match)
const tokenTxs = transactions.filter(tx => {
  const tokens = [tx.inputToken, tx.outputToken];
  const hasDisplayToken = tokens.includes(displayToken);
  const hasCounterToken = tokens.includes(counterToken);
  return hasDisplayToken && hasCounterToken;
});
```

**`src/app/swap/components/SwapPriceChart.tsx`**
- Added `quoteToken` prop to interface
- Passed to `usePriceData()` hook

**`src/app/swap/components/TabbedPriceChart.tsx`**
- Now passes correct pair tokens to each chart tab:
  - Base tab: `token={baseToken}` + `quoteToken={quoteToken}`
  - Quote tab: `token={quoteToken}` + `quoteToken={baseToken}`

---

## ðŸ› Bug #2: Slow Transaction Updates

**Symptom:** After swapping, refreshing 5-6 times still showed stale data

**Root Cause:** Redis cache sync interval was 5 minutes:

```typescript
const SYNC_INTERVAL = 5 * 60 * 1000; // 5 minutes - TOO LONG!
```

---

## âœ… Fix #2: Faster Cache Sync

**`src/app/api/swap-history/route.ts`**
- Changed sync interval from 5 minutes to 30 seconds:

```typescript
const SYNC_INTERVAL = 30 * 1000; // 30 seconds - faster updates
```

---

## ðŸ“ Key Patterns Established

### Multi-Pair DEX: Always Filter by Pair, Not Token

When displaying data for a specific trading pair:

```typescript
// âœ… CORRECT: Filter by BOTH tokens in the pair
const pairTxs = allTxs.filter(tx => {
  const tokens = [tx.inputToken, tx.outputToken];
  return tokens.includes(baseToken) && tokens.includes(quoteToken);
});

// âŒ WRONG: Filter by single token
const tokenTxs = allTxs.filter(tx => 
  tx.inputToken === token || tx.outputToken === token
);
```

### Redis Caching: Balance Freshness vs API Load

| Interval | Freshness | Upstash Calls/Day |
|----------|-----------|-------------------|
| 5 min    | Stale UX  | ~300              |
| 30 sec   | Good UX   | ~3000             |
| 10 sec   | Real-time | ~9000 (near limit)|

Free tier limit: 10,000 commands/day. 30 seconds is the sweet spot.

---

## ðŸ”‘ Key Insight: Multiple Pairs Require Explicit Context

With V3 multi-pair DEX, we can no longer assume "DGKO price" means "DGKO/KLV price". Every price calculation needs explicit pair context:

- Chart: Which pair is selected?
- Swap rate: What's the counter-token?
- Transaction history: Filter by pair, not just token

---

## ðŸ§ª Verification

After fix, console logs show proper filtering:
```
ðŸ“Š [usePriceData] DGKO/KLV: Found 45/120 matching pair transactions
```

This confirms only DGKOâ†”KLV transactions are used for the DGKO/KLV chart.

---

## ðŸ“š Files Changed

1. `src/app/swap/hooks/usePriceData.ts` - Pair-aware filtering
2. `src/app/swap/components/SwapPriceChart.tsx` - Added quoteToken prop
3. `src/app/swap/components/TabbedPriceChart.tsx` - Pass pair context
4. `src/app/api/swap-history/route.ts` - 30s sync interval
