# Lessons Learned - December 21, 2025

## Session Focus: Token Precision Centralization

### Critical Bug Fixed: DAXDO Display Error

**Symptom:** Dashboard showed 16,000,000 DAXDO instead of 160,000 (100x error)

**Root Cause Chain:**
1. DAXDO token not in `NetworkTokensContext.tsx` token list
2. `getDecimals('DAXDO')` returned `undefined`
3. Code used `|| 6` fallback (6 decimals = 1,000,000 precision)
4. DAXDO actually has 8 decimals = 100,000,000 precision
5. `16000000000 / 1000000 = 16000` vs `16000000000 / 100000000 = 160`

---

## Audit Findings: 27 Hardcoded Precision Violations

### Category 1: Duplicate PRECISION Constants (5 files)
- `src/app/dgko/config/dgko.config.tsx` - `DGKO_PRECISION = 10000`
- `src/app/swap/config/swap.config.tsx` - `DGKO_PRECISION`, `KLV_PRECISION`
- `src/app/babydgko/config/babydgko.config.tsx` - `BABYDGKO_PRECISION`
- `src/app/staking/types/klv-staking.types.ts` - `KLV_PRECISION = 6`

### Category 2: Duplicate TOKENS Objects (2 files)
- `src/utils/smartContractUtils.ts` - Local TOKENS object
- `src/context/NetworkTokensContext.tsx` - Network-specific TOKENS

### Category 3: Hardcoded Fallback Defaults (14 locations)
Files with `|| 6` or `?? 6` patterns that fail for non-6-decimal tokens:
- `useTokenBalances.ts` - `getDecimals(baseSymbol) || 6`
- `swap/page.tsx` - `decimals || 6`
- `pool/page.tsx` - `precision || 1`
- `admin/trading-pairs/page.tsx` - `precision || 1000000`
- Multiple others...

### Category 4: Token-Specific Ternary Checks
```typescript
// Found in multiple files - doesn't scale
const decimals = token === 'DGKO' ? 4 : 6;
```

---

## Solution Applied

### 1. Single Source of Truth
All precision now comes from `src/config/tokens.ts` → `TOKEN_REGISTRY`

### 2. Helper Functions
```typescript
getTokenDecimals(symbol)  // Returns decimals (e.g., 8 for DAXDO)
getTokenPrecision(symbol) // Returns precision (e.g., 100000000)
```

### 3. Files Modified (24 total)
- Removed duplicate constants from 5 config files
- Updated 10 files with `|| 6` fallbacks
- Updated 6 token page configs
- Added missing tokens to NetworkTokensContext
- Updated utility files to use centralized config

### 4. Documentation Created
- `docs/dev/TOKEN_PRECISION_GUIDE.md` - Comprehensive guide

---

## Key Lessons

### Lesson 1: Fallback Values Are Dangerous
```typescript
// NEVER
const decimals = value || 6;  // Silent failure for 8-decimal tokens

// ALWAYS
const decimals = getTokenDecimals(symbol);  // Handles unknowns properly
```

### Lesson 2: Duplicate Constants Drift
Having `DGKO_PRECISION` in 3 files seems harmless until someone updates one and forgets the others.

### Lesson 3: Ternary Checks Don't Scale
```typescript
// Worked until DAXDO came along
const precision = token === 'DGKO' ? 10000 : 1000000;
```

### Lesson 4: Test With Non-Standard Tokens
Most tokens have 6 decimals. Testing only with KLV/DGKO won't catch issues with 8-decimal tokens like DAXDO/BABYDGKO.

---

## Prevention Checklist

When adding new tokens:
- [ ] Add to `src/config/tokens.ts` TOKEN_REGISTRY
- [ ] Add to `NetworkTokensContext.tsx` if needed for UI
- [ ] Test dashboard display with actual balance
- [ ] Test transactions (send/receive amounts)

Before releases:
- [ ] Run precision audit: `grep -rn "|| 6\|?? 6\|precision.*=.*[0-9]" src/`
- [ ] Verify no new hardcoded precision values

---

## Audit Command

```bash
# Find potential precision issues
grep -rn "precision\s*[=:]\s*[0-9]\{4,\}\|decimals\s*=\s*[0-9]\||| 6\|?? 6" \
  --include="*.ts" --include="*.tsx" src/ \
  | grep -v "config/tokens.ts\|node_modules\|\.next"
```

---

## Related Documentation

- `docs/dev/TOKEN_PRECISION_GUIDE.md` - Full precision guide
- `src/config/tokens.ts` - Source of truth
- `/admin/tokens/precision` - Visual management UI

---

## Session 2: Performance Audit & Optimization

### What We Did
1. **Full codebase audit** - Identified performance issues from critical to low
2. **Fixed context memoization** - All 3 providers now use `useMemo`
3. **Fixed SSR bug** - localStorage access protected
4. **Consolidated formatters** - 10 duplicate `formatKLV` → 1 source
5. **BABYDGKO compact format** - Meme tokens display as "854.6M" not "854,622,679.71"

---

## Critical Discovery: Context Memoization

### Problem
All three context providers were creating **new value objects on every render**:

```typescript
// ❌ BAD - Creates new object every render
const value: KleverContextType = {
  address,
  balance,
  ...
};
return <Provider value={value}>{children}</Provider>;
```

### Impact
Every state change anywhere caused ALL 139 `'use client'` components to re-render.

### Solution
```typescript
// ✅ GOOD - Memoized, only updates when deps change
const value = useMemo(() => ({
  address,
  balance,
  ...
}), [address, balance, ...]);
```

### Files Fixed
- `src/context/KleverContext.tsx`
- `src/context/TokenPricesContext.tsx`
- `src/context/NetworkTokensContext.tsx` (already had it)

---

## SSR Bug: localStorage Access

### Problem
Line 138 in KleverContext accessed `localStorage` without protection:

```typescript
// Line 130-135 had the check...
if (typeof window !== 'undefined') {
  const stored = localStorage.getItem('digiko-network');
}

// But line 138 was OUTSIDE the check!
if (!localStorage.getItem('digiko-network')) { // ❌ SSR crash!
```

### Solution
```typescript
if (typeof window !== 'undefined' && !localStorage.getItem('digiko-network')) {
```

---

## Formatter Consolidation

### Problem
`formatKLV` was defined **10 times** across the codebase with slight variations.

### Solution
Created `src/utils/formatters.ts` as single source of truth:

| Function | Use Case | Output |
|----------|----------|--------|
| `formatKLV(amount)` | Standard display | `1,234.56` |
| `formatKLVCompact(amount)` | Large amounts | `1.2M` |
| `formatKLVPrecise(amount)` | Rewards | `0.001234` |
| `formatKLVFull(amount)` | Always 2 decimals | `1,234.00` |
| `formatKLVFromKaons(kaons)` | Raw → Human | Divides by precision |
| `formatUSD(price)` | USD prices | `$0.001234` |
| `formatReserve(value)` | Pool reserves | `1.5M` |

### Files Updated
- `src/utils/constants.ts` - Re-exports for backward compat
- `src/components/validators/validators.config.ts`
- `src/app/validators/config/validators.config.tsx`
- `src/app/staking/components/klv/KLVStakingStatsGrid.tsx`
- `src/app/staking/components/klv/KLVRewardsCard.tsx`
- `src/app/staking/components/klv/KLVBucketsCard.tsx`
- `src/app/staking/types/klv-staking.types.ts`
- `src/app/admin/tokens/prices/page.tsx`
- `src/app/staking/hooks/useStakingData.ts`

---

## BABYDGKO Compact Format

### Problem
BABYDGKO balances showing as `854,622,679.71` - visually chaotic.

### Solution
Created token-specific formatter in `useStakingData.ts`:

```typescript
function formatTokenBalance(rawAmount: number, precision: number, token: TokenSymbol): string {
  const humanAmount = rawAmount / Math.pow(10, precision);
  
  // BABYDGKO uses compact format
  if (token === 'BABYDGKO') {
    return formatKLVCompact(humanAmount);
  }
  
  return formatKLV(rawAmount, precision);
}
```

**Before:** `854,622,679.71 BABYDGKO`  
**After:** `854.6M BABYDGKO`

---

## Performance Audit Summary

### Fixed ✅
- Context memoization (3 providers) - **CRITICAL**
- SSR localStorage bug - **CRITICAL**
- Duplicate formatKLV (10 → 1) - **HIGH**
- BABYDGKO display format - **MEDIUM**

### Not Fixed (Low Priority)
- 748 console.log statements (cleanup task)
- 141 `any` types (type safety, not runtime)
- Large utility file (1714 lines) - refactor later
- Duplicate hooks (3 token balance, 3 contract queries)

---

## Key Takeaways

1. **Always memoize context values** - Use `useMemo` for provider value objects
2. **Always guard browser APIs** - `typeof window !== 'undefined'`
3. **Centralize formatters** - One source of truth prevents drift
4. **Token-specific formatting** - Meme tokens need special handling
